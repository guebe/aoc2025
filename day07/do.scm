(import (srfi 1))

(define example-beams '(7))

(define example '(
"..............."
".......^......."
"..............."
"......^.^......"
"..............."
".....^.^.^....."
"..............."
"....^.^...^...."
"..............."
"...^.^...^.^..."
"..............."
"..^...^.....^.."
"..............."
".^.^.^.^.^...^."
"..............."
))

(define input-beams '(70))

(define input '(
"............................................................................................................................................."
"......................................................................^......................................................................"
"............................................................................................................................................."
".....................................................................^.^....................................................................."
"............................................................................................................................................."
"....................................................................^...^...................................................................."
"............................................................................................................................................."
"...................................................................^.^.^.^..................................................................."
"............................................................................................................................................."
"..................................................................^.^.....^.................................................................."
"............................................................................................................................................."
".................................................................^.^.^.^...^................................................................."
"............................................................................................................................................."
"................................................................^.^.^...^...^................................................................"
"............................................................................................................................................."
"...............................................................^.^.^.^...^.^.^..............................................................."
"............................................................................................................................................."
"..............................................................^.^.^...^.^.^.^.^.............................................................."
"............................................................................................................................................."
".............................................................^.^.^...^...^...^.^............................................................."
"............................................................................................................................................."
"............................................................^...^.^.^.^.^.^.....^............................................................"
"............................................................................................................................................."
"...........................................................^.......^...^.^.^...^.^..........................................................."
"............................................................................................................................................."
"..........................................................^.^.^.^.......^.^.^.^.^.^.........................................................."
"............................................................................................................................................."
".........................................................^.^.^.^.^.^.........^.^.^.^........................................................."
"............................................................................................................................................."
"........................................................^.^.^.^.^...^.^.^.^.^.^.^.^.^........................................................"
"............................................................................................................................................."
".......................................................^.^.^.....^...^.....^.........^......................................................."
"............................................................................................................................................."
"......................................................^.^.^.^.^...^...^.^...^.^.^...^.^......................................................"
"............................................................................................................................................."
".....................................................^...^.^.^.^.^.^...^...^...^.^.^.^.^....................................................."
"............................................................................................................................................."
"....................................................^.^...^.^...^.^.^.^.^.^.....^.^.^.^.^...................................................."
"............................................................................................................................................."
"...................................................^.^...^.^...^...^.^.....^.....^...^.^.^..................................................."
"............................................................................................................................................."
"..................................................^.^.....^...^.^...^.^.^.^.^.^.^.^.^...^.^.................................................."
"............................................................................................................................................."
".................................................^...^.^...^...^.^.....^.....^.........^.^.^................................................."
"............................................................................................................................................."
"................................................^.^.^...^.^.^.^.^.......^...^.^.^.^.^.^...^.^................................................"
"............................................................................................................................................."
"...............................................^.........^.^.^.^.........^...^.^.^...^...^.^.^..............................................."
"............................................................................................................................................."
"..............................................^...^.^.^.^...^.^.^.^...^.^.^...^.....^.....^.^.^.............................................."
"............................................................................................................................................."
".............................................^.....^.^.......^.^...^.^.^.^.......^.^.^.^...^...^............................................."
"............................................................................................................................................."
"............................................^...^...^.^.^.^.^...^.^.^.^...........^.^...^...^.^.^............................................"
"............................................................................................................................................."
"...........................................^.^.^.^...^...^...^.^.^.....^.^.^.^.....^...^.^.^.^.^.^..........................................."
"............................................................................................................................................."
"..........................................^...^...^.^.^.....^.^...^.^.^.^.^.^.......^.^.^...^.^...^.........................................."
"............................................................................................................................................."
".........................................^...^.^...^.^.....^.^.^.^.^.^.^.^...^.^.^.^.^.^.^...^.....^........................................."
"............................................................................................................................................."
"........................................^.^...^.^.^.^.^.^.^.^.......^...^.^.^.^.......^.^.^.^.^...^.^........................................"
"............................................................................................................................................."
".......................................^.^...^.^.^.^.^.^.^.^.^.^...^.^.....^...^...^...^.^.^.^.^.^...^......................................."
"............................................................................................................................................."
"......................................^.^.^...^.^.^.^.^.^...........^.^.^.^.^.^...^.^.....^.^.^.^.^.^.^......................................"
"............................................................................................................................................."
".....................................^.^.^.......^.^.^.......^...^.....^.^.^...^.^.^...^.^.^...^.^.^...^....................................."
"............................................................................................................................................."
"....................................^.^...^.^.....^.^.^...^.^.^.^.^.....^.......^.^.^...^...........^.^.^...................................."
"............................................................................................................................................."
"...................................^.^.^...^.^.^.^...^...^.......^.^.^.^.^...^.^.^.^.^.^.^...^.^.....^...^..................................."
"............................................................................................................................................."
"..................................^.^.....^.........^...^.^.^.^.......^.^.^...^.....^.........^.^.........^.................................."
"............................................................................................................................................."
".................................^.^.^.^.^.^.^.^.^...^.^...^.^.......^.^.^...^.......^.^.....^...^.^.^.....^................................."
"............................................................................................................................................."
"................................^.^...^...^.^.^.^...^.^.......^.^.^.^.^.^.^.^...^.^.^.....^.^.....^...^.....^................................"
"............................................................................................................................................."
"...............................^...^.^.^.^...^.^.^.^.^...^.^...^.^.^.....^.^.^.^.^.^.^...^.......^.^.^...^.^.^..............................."
"............................................................................................................................................."
"..............................^...^.^...^.^.^.^.^.^.^.^.......^.^.^.^.^.^...^.........^.^.....^.^.^.^...^.^...^.............................."
"............................................................................................................................................."
".............................^...^.^.^...^.^...^.^.^...^.^...^...^.^.^.^.......^.^...^.^...^...^.^.^...^.^.^.^.^............................."
"............................................................................................................................................."
"............................^.........^...........^.........^.^.^...^.^.^.^.......^...^.^.^...^.^...^.^.^.^...^.^............................"
"............................................................................................................................................."
"...........................^.....^.^.^.^.^...^...^.^.....^.^.^...^...^.^.^.^.^...^.^...^...^.^.^.^.^...^.^.^...^.^..........................."
"............................................................................................................................................."
"..........................^.^.^.^.^...^.....^.^.....^.^.^.^.^.^.^.^...^.^.^.^.^.^.^...^.^.^.......^.......^.^.^.^.^.........................."
"............................................................................................................................................."
".........................^.^.^.....^.^.^.^.^.^.....^...^.^.^.^.......^.^.^.^.^.^.^.^.^...^.^...^.^.^...^.^...^.^.^.^........................."
"............................................................................................................................................."
"........................^.^.^.....^.^.^...^.^.^.^.^.^...^.....^.....^.....^.^.^...^...^.^.....^...^.^.^.^.^.^.^...^.^........................"
"............................................................................................................................................."
".......................^.^.......^.^...^.^.^.^.^...^...^.^.^.......^.^.......^...^.....^.^...^.^.^...^.^...^.^.^.^.^.^......................."
"............................................................................................................................................."
"......................^...^.^.^.^.^...^.^.^.....^.^...^.^...^.....^.^.^.^.^.^.^.^.......^.^.....^...^.^.^.^.^.^.^.....^......................"
"............................................................................................................................................."
".....................^...^.....^.^.^.^.......^.^.^.......^...........^...^.^...^.^.^.^...^.^...^.^...^.^.^.^.^...^...^.^....................."
"............................................................................................................................................."
"....................^.^.^...^.^.....^...^...^.^.^.^.^.^.^.^.^.^.^.^...^.^...^.^.^.^.^...^.^.^...^.^...^.^.....^...^.^.^.^...................."
"............................................................................................................................................."
"...................^.....^...^.^.^.^...^.......^.^...^.^.^.^...^.^...^.^.^...^.^.^...^.^.^...^.....^.^.^.^.^.^.^.^.^.^.^.^..................."
"............................................................................................................................................."
"..................^.^.^.^.^...^.^.^.^...^.^.^.^.^...^.^.^.^...^...^...^.^.......^.^.^.^.....^.^...^.^.^...^...^.^.....^.^.^.................."
"............................................................................................................................................."
".................^.^.^.^.^...^.^.......^.^.^...^.^...^...^...^.^.^.^...^.^...^.^.^.^.^.^.^...^.^.^.^.^.^...^...^.^...^...^.^................."
"............................................................................................................................................."
"................^.^...^...........^.^.^.......^.^...^.^.^.......^...^.^.^...^...^.^...^...^.^.^.^.^.^.^.....^.^.^.^.^...^.^.^................"
"............................................................................................................................................."
"...............^.^.....^.^...^.^...^...^.^.^.^.^.^.^.^.^...^.^...^...^.^.^.^.^.^.^.^.^.^.^.^.^.^...^.^...^.........^.^.^.^.^.^..............."
"............................................................................................................................................."
"..............^...^...^.^.^.^.^.^...^.^.^...^.^.....^.^.^.......^...^.^...^.^.^...^...^.^.^.^.^...^.^...^.^...........^.....^.^.............."
"............................................................................................................................................."
".............^.......^...^...^.^...^.^.^.....^.......^.^.^...^.^.^.^.^.^.^.^.......^...^.^.^.^.^.^.^.....^.^.......^.....^.^.^.^............."
"............................................................................................................................................."
"............^...^.^.^.^.^.....^.^.^.^.^.^.^.^.^.^.^...^.^.^.^...^.^...^.^.....^.^...^.......^...^...........^.^.^...^.^...^.^.^.^............"
"............................................................................................................................................."
"...........^.....^.^.^...^.^.^.^.^.....^...^...^...^.^.^.......^.....^.^.^.^.....^.^.^.^.^.^.^.^...^.^.^.^.^.^.^...^.^...^.^...^.^..........."
"............................................................................................................................................."
"..........^.^.^.^.^.^.^...^...^...^.....^.^.........^...^.^.....^...^...^.^.....^.^.^.^.^...^.^.^...^.^.^...^.....^.....^.^...^.^.^.........."
"............................................................................................................................................."
".........^.^...^.^...^...^.....^...^.^.........^...^.^.^.....^.^...........^.^...^.^.^...^.^.......^.^.^.^.^...^.^.^.^...^.^.^.....^........."
"............................................................................................................................................."
"........^.^.^.^.^...^...^.....^...^.^.^.^.........^...^.^.^.....^...^.^...^.^.^.....^.^.^.^.^.....^...^.^...^.^.^.^...^.^...^.^.^.^.^........"
"............................................................................................................................................."
".......^...^.^.^...^.......^.....^.^...^.^.^.^.^.^.^.^...^...^.^.^.^.^.^.^.^.^...^.^.^.^.^.^.^.^.^...^.^.^.^.^.^...^.^.^.^.^.....^.^.^......."
"............................................................................................................................................."
"......^...^.^.^...^...^.^...^.^.....^.^.....^.^.^.^...^.^...^...^.....^.^...^.^.^.^.^.^.^...^.^.^.^.^...^.^.^.^.^.^.^...^.^.^...^.....^......"
"............................................................................................................................................."
".....^.....^...^.^.^...^...^.^.^.^.^...^.^.^.^.^...^.^...^.^.^.....^...^.^.^.^.....^...^.........^.....^.^...^.^.^.....^.^.^.^.^.^.....^....."
"............................................................................................................................................."
"....^.....^.^.^.......^.^.....^.^.^.^.....^.^.^.^...^.^.^.^.^.^.....^.^...^...^.^.^.^.^.^.........^.^.^.^.^...^.^.^...^.^.^...^.^...^.^.^...."
"............................................................................................................................................."
"...^.........^.^.^...^...^.^.^.^.....^.^...^.^.....^.^.^...^.^.^.....^.^.^...^.^.^.^.^.^.^.^.....^.^.^.^...^.....^.^.^.^.^...^.......^.^.^..."
"............................................................................................................................................."
"..^.^...^.^...^.^.^.^.....^.^.....^...^.^.....^.^.^.^.^...^.....^.^.^...^.^.........^.^.^.........^.........^.^.^.^.^.^...^.^.^.^.^.^...^.^.."
"............................................................................................................................................."
".^.....^...^.^.^...^.^.^.^.^.^.^.^.^.^...^.^.^.^.^.^.^.^...^.^...^.^.^.^.^...^.^.....^.^...^.^.^.^.^...^...^...^...^.^.^...^.........^.^.^.^."
"............................................................................................................................................."
))

(define (filter-splitter splitter)
  (filter
    (lambda (pos) (char=? (list-ref splitter pos) #\^))
    (iota (length splitter))))

(define (filter-colide splitters beams)
  (filter (lambda (beam) (member beam splitters)) beams))

(define (filter-non-colide splitters beams)
  (filter (lambda (beam) (not (member beam splitters))) beams))

(define (colide-or-pass splitters beams)
  (let* ((colisions (filter-colide splitters beams))
         (non-colisions (filter-non-colide splitters beams))
	 (left-colisions (map (lambda (x) (- x 1)) colisions))
	 (right-colisions (map (lambda (x) (+ x 1)) colisions)))
    (cons
      (length colisions)
      (delete-duplicates (append non-colisions left-colisions right-colisions)))))

(define (part1-step state splitters)
  (let ((num (car state))
	(beams (cdr state)))
     (let ((next (colide-or-pass splitters beams)))
       (let ((new-num (car next))
	     (new-beams (cdr next)))
	 (cons (+ num new-num) new-beams)))))

(define (part1 x x-beams)
  (car (foldl part1-step (cons 0 x-beams) (map filter-splitter (map string->list x)))))

(display (part1 example example-beams)) (newline)
(display (part1 input input-beams)) (newline)

