(import (srfi 1))

(define example '(
"..............."
".......^......."
"..............."
"......^.^......"
"..............."
".....^.^.^....."
"..............."
"....^.^...^...."
"..............."
"...^.^...^.^..."
"..............."
"..^...^.....^.."
"..............."
".^.^.^.^.^...^."
"..............."
))

(define input '(
"............................................................................................................................................."
"......................................................................^......................................................................"
"............................................................................................................................................."
".....................................................................^.^....................................................................."
"............................................................................................................................................."
"....................................................................^...^...................................................................."
"............................................................................................................................................."
"...................................................................^.^.^.^..................................................................."
"............................................................................................................................................."
"..................................................................^.^.....^.................................................................."
"............................................................................................................................................."
".................................................................^.^.^.^...^................................................................."
"............................................................................................................................................."
"................................................................^.^.^...^...^................................................................"
"............................................................................................................................................."
"...............................................................^.^.^.^...^.^.^..............................................................."
"............................................................................................................................................."
"..............................................................^.^.^...^.^.^.^.^.............................................................."
"............................................................................................................................................."
".............................................................^.^.^...^...^...^.^............................................................."
"............................................................................................................................................."
"............................................................^...^.^.^.^.^.^.....^............................................................"
"............................................................................................................................................."
"...........................................................^.......^...^.^.^...^.^..........................................................."
"............................................................................................................................................."
"..........................................................^.^.^.^.......^.^.^.^.^.^.........................................................."
"............................................................................................................................................."
".........................................................^.^.^.^.^.^.........^.^.^.^........................................................."
"............................................................................................................................................."
"........................................................^.^.^.^.^...^.^.^.^.^.^.^.^.^........................................................"
"............................................................................................................................................."
".......................................................^.^.^.....^...^.....^.........^......................................................."
"............................................................................................................................................."
"......................................................^.^.^.^.^...^...^.^...^.^.^...^.^......................................................"
"............................................................................................................................................."
".....................................................^...^.^.^.^.^.^...^...^...^.^.^.^.^....................................................."
"............................................................................................................................................."
"....................................................^.^...^.^...^.^.^.^.^.^.....^.^.^.^.^...................................................."
"............................................................................................................................................."
"...................................................^.^...^.^...^...^.^.....^.....^...^.^.^..................................................."
"............................................................................................................................................."
"..................................................^.^.....^...^.^...^.^.^.^.^.^.^.^.^...^.^.................................................."
"............................................................................................................................................."
".................................................^...^.^...^...^.^.....^.....^.........^.^.^................................................."
"............................................................................................................................................."
"................................................^.^.^...^.^.^.^.^.......^...^.^.^.^.^.^...^.^................................................"
"............................................................................................................................................."
"...............................................^.........^.^.^.^.........^...^.^.^...^...^.^.^..............................................."
"............................................................................................................................................."
"..............................................^...^.^.^.^...^.^.^.^...^.^.^...^.....^.....^.^.^.............................................."
"............................................................................................................................................."
".............................................^.....^.^.......^.^...^.^.^.^.......^.^.^.^...^...^............................................."
"............................................................................................................................................."
"............................................^...^...^.^.^.^.^...^.^.^.^...........^.^...^...^.^.^............................................"
"............................................................................................................................................."
"...........................................^.^.^.^...^...^...^.^.^.....^.^.^.^.....^...^.^.^.^.^.^..........................................."
"............................................................................................................................................."
"..........................................^...^...^.^.^.....^.^...^.^.^.^.^.^.......^.^.^...^.^...^.........................................."
"............................................................................................................................................."
".........................................^...^.^...^.^.....^.^.^.^.^.^.^.^...^.^.^.^.^.^.^...^.....^........................................."
"............................................................................................................................................."
"........................................^.^...^.^.^.^.^.^.^.^.......^...^.^.^.^.......^.^.^.^.^...^.^........................................"
"............................................................................................................................................."
".......................................^.^...^.^.^.^.^.^.^.^.^.^...^.^.....^...^...^...^.^.^.^.^.^...^......................................."
"............................................................................................................................................."
"......................................^.^.^...^.^.^.^.^.^...........^.^.^.^.^.^...^.^.....^.^.^.^.^.^.^......................................"
"............................................................................................................................................."
".....................................^.^.^.......^.^.^.......^...^.....^.^.^...^.^.^...^.^.^...^.^.^...^....................................."
"............................................................................................................................................."
"....................................^.^...^.^.....^.^.^...^.^.^.^.^.....^.......^.^.^...^...........^.^.^...................................."
"............................................................................................................................................."
"...................................^.^.^...^.^.^.^...^...^.......^.^.^.^.^...^.^.^.^.^.^.^...^.^.....^...^..................................."
"............................................................................................................................................."
"..................................^.^.....^.........^...^.^.^.^.......^.^.^...^.....^.........^.^.........^.................................."
"............................................................................................................................................."
".................................^.^.^.^.^.^.^.^.^...^.^...^.^.......^.^.^...^.......^.^.....^...^.^.^.....^................................."
"............................................................................................................................................."
"................................^.^...^...^.^.^.^...^.^.......^.^.^.^.^.^.^.^...^.^.^.....^.^.....^...^.....^................................"
"............................................................................................................................................."
"...............................^...^.^.^.^...^.^.^.^.^...^.^...^.^.^.....^.^.^.^.^.^.^...^.......^.^.^...^.^.^..............................."
"............................................................................................................................................."
"..............................^...^.^...^.^.^.^.^.^.^.^.......^.^.^.^.^.^...^.........^.^.....^.^.^.^...^.^...^.............................."
"............................................................................................................................................."
".............................^...^.^.^...^.^...^.^.^...^.^...^...^.^.^.^.......^.^...^.^...^...^.^.^...^.^.^.^.^............................."
"............................................................................................................................................."
"............................^.........^...........^.........^.^.^...^.^.^.^.......^...^.^.^...^.^...^.^.^.^...^.^............................"
"............................................................................................................................................."
"...........................^.....^.^.^.^.^...^...^.^.....^.^.^...^...^.^.^.^.^...^.^...^...^.^.^.^.^...^.^.^...^.^..........................."
"............................................................................................................................................."
"..........................^.^.^.^.^...^.....^.^.....^.^.^.^.^.^.^.^...^.^.^.^.^.^.^...^.^.^.......^.......^.^.^.^.^.........................."
"............................................................................................................................................."
".........................^.^.^.....^.^.^.^.^.^.....^...^.^.^.^.......^.^.^.^.^.^.^.^.^...^.^...^.^.^...^.^...^.^.^.^........................."
"............................................................................................................................................."
"........................^.^.^.....^.^.^...^.^.^.^.^.^...^.....^.....^.....^.^.^...^...^.^.....^...^.^.^.^.^.^.^...^.^........................"
"............................................................................................................................................."
".......................^.^.......^.^...^.^.^.^.^...^...^.^.^.......^.^.......^...^.....^.^...^.^.^...^.^...^.^.^.^.^.^......................."
"............................................................................................................................................."
"......................^...^.^.^.^.^...^.^.^.....^.^...^.^...^.....^.^.^.^.^.^.^.^.......^.^.....^...^.^.^.^.^.^.^.....^......................"
"............................................................................................................................................."
".....................^...^.....^.^.^.^.......^.^.^.......^...........^...^.^...^.^.^.^...^.^...^.^...^.^.^.^.^...^...^.^....................."
"............................................................................................................................................."
"....................^.^.^...^.^.....^...^...^.^.^.^.^.^.^.^.^.^.^.^...^.^...^.^.^.^.^...^.^.^...^.^...^.^.....^...^.^.^.^...................."
"............................................................................................................................................."
"...................^.....^...^.^.^.^...^.......^.^...^.^.^.^...^.^...^.^.^...^.^.^...^.^.^...^.....^.^.^.^.^.^.^.^.^.^.^.^..................."
"............................................................................................................................................."
"..................^.^.^.^.^...^.^.^.^...^.^.^.^.^...^.^.^.^...^...^...^.^.......^.^.^.^.....^.^...^.^.^...^...^.^.....^.^.^.................."
"............................................................................................................................................."
".................^.^.^.^.^...^.^.......^.^.^...^.^...^...^...^.^.^.^...^.^...^.^.^.^.^.^.^...^.^.^.^.^.^...^...^.^...^...^.^................."
"............................................................................................................................................."
"................^.^...^...........^.^.^.......^.^...^.^.^.......^...^.^.^...^...^.^...^...^.^.^.^.^.^.^.....^.^.^.^.^...^.^.^................"
"............................................................................................................................................."
"...............^.^.....^.^...^.^...^...^.^.^.^.^.^.^.^.^...^.^...^...^.^.^.^.^.^.^.^.^.^.^.^.^.^...^.^...^.........^.^.^.^.^.^..............."
"............................................................................................................................................."
"..............^...^...^.^.^.^.^.^...^.^.^...^.^.....^.^.^.......^...^.^...^.^.^...^...^.^.^.^.^...^.^...^.^...........^.....^.^.............."
"............................................................................................................................................."
".............^.......^...^...^.^...^.^.^.....^.......^.^.^...^.^.^.^.^.^.^.^.......^...^.^.^.^.^.^.^.....^.^.......^.....^.^.^.^............."
"............................................................................................................................................."
"............^...^.^.^.^.^.....^.^.^.^.^.^.^.^.^.^.^...^.^.^.^...^.^...^.^.....^.^...^.......^...^...........^.^.^...^.^...^.^.^.^............"
"............................................................................................................................................."
"...........^.....^.^.^...^.^.^.^.^.....^...^...^...^.^.^.......^.....^.^.^.^.....^.^.^.^.^.^.^.^...^.^.^.^.^.^.^...^.^...^.^...^.^..........."
"............................................................................................................................................."
"..........^.^.^.^.^.^.^...^...^...^.....^.^.........^...^.^.....^...^...^.^.....^.^.^.^.^...^.^.^...^.^.^...^.....^.....^.^...^.^.^.........."
"............................................................................................................................................."
".........^.^...^.^...^...^.....^...^.^.........^...^.^.^.....^.^...........^.^...^.^.^...^.^.......^.^.^.^.^...^.^.^.^...^.^.^.....^........."
"............................................................................................................................................."
"........^.^.^.^.^...^...^.....^...^.^.^.^.........^...^.^.^.....^...^.^...^.^.^.....^.^.^.^.^.....^...^.^...^.^.^.^...^.^...^.^.^.^.^........"
"............................................................................................................................................."
".......^...^.^.^...^.......^.....^.^...^.^.^.^.^.^.^.^...^...^.^.^.^.^.^.^.^.^...^.^.^.^.^.^.^.^.^...^.^.^.^.^.^...^.^.^.^.^.....^.^.^......."
"............................................................................................................................................."
"......^...^.^.^...^...^.^...^.^.....^.^.....^.^.^.^...^.^...^...^.....^.^...^.^.^.^.^.^.^...^.^.^.^.^...^.^.^.^.^.^.^...^.^.^...^.....^......"
"............................................................................................................................................."
".....^.....^...^.^.^...^...^.^.^.^.^...^.^.^.^.^...^.^...^.^.^.....^...^.^.^.^.....^...^.........^.....^.^...^.^.^.....^.^.^.^.^.^.....^....."
"............................................................................................................................................."
"....^.....^.^.^.......^.^.....^.^.^.^.....^.^.^.^...^.^.^.^.^.^.....^.^...^...^.^.^.^.^.^.........^.^.^.^.^...^.^.^...^.^.^...^.^...^.^.^...."
"............................................................................................................................................."
"...^.........^.^.^...^...^.^.^.^.....^.^...^.^.....^.^.^...^.^.^.....^.^.^...^.^.^.^.^.^.^.^.....^.^.^.^...^.....^.^.^.^.^...^.......^.^.^..."
"............................................................................................................................................."
"..^.^...^.^...^.^.^.^.....^.^.....^...^.^.....^.^.^.^.^...^.....^.^.^...^.^.........^.^.^.........^.........^.^.^.^.^.^...^.^.^.^.^.^...^.^.."
"............................................................................................................................................."
".^.....^...^.^.^...^.^.^.^.^.^.^.^.^.^...^.^.^.^.^.^.^.^...^.^...^.^.^.^.^...^.^.....^.^...^.^.^.^.^...^...^...^...^.^.^...^.........^.^.^.^."
"............................................................................................................................................."
))

(define (filter-splitter splitter)
  (filter
    (lambda (pos) (char=? (list-ref splitter pos) #\^))
    (iota (length splitter))))

(define (filter-colide splitters beams)
  (filter (lambda (beam) (member (car beam) splitters)) beams))

(define (filter-non-colide splitters beams)
  (filter (lambda (beam) (not (member (car beam) splitters))) beams))

(define (is-same-beam? b1 b2) (let ((b1id (car b1)) (b2id (car b2))) (= b1id b2id)))

(define (merge-duplicates acc beam)
  (let ((same-beam (filter (lambda (x) (is-same-beam? x beam)) acc))
        (not-same-beam (filter (lambda (x) (not (is-same-beam? x beam))) acc)))
    (if (null? same-beam)
      (cons beam acc)
      (cons (cons (car beam) (+ (cdr (car same-beam)) (cdr beam))) not-same-beam))))

(define (colide-or-pass beams splitters)
  (let* ((colisions (filter-colide splitters beams))
         (non-colisions (filter-non-colide splitters beams))
	 (left-colisions (map (lambda (x) (let ((beam (car x))(multiplier (cdr x))) (cons (- beam 1) multiplier))) colisions))
	 (right-colisions (map (lambda (x) (let ((beam (car x))(multiplier (cdr x))) (cons (+ beam 1) multiplier))) colisions)))
    (foldl merge-duplicates '() (append non-colisions left-colisions right-colisions))))

(define (add-beam state r)
  (+ state (cdr r)))

(define (part2 x x-beams)
  (foldl add-beam 0 (foldl colide-or-pass x-beams (map filter-splitter (map string->list x)))))

(display (part2 example '((7 . 1)))) (newline)
(display (part2 input '((70 . 1)))) (newline)
